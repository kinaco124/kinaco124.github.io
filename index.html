<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外食PFC・カロリーナビ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #FDFBF7; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 400px; max-height: 50vh; }
        @media (min-width: 768px) { .chart-container { height: 500px; } }
        .table-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-scrollbar::-webkit-scrollbar-thumb { background: #c4b5a5; border-radius: 10px; }
        .table-scrollbar::-webkit-scrollbar-thumb:hover { background: #a89988; }
        .nav-button { transition: all 0.3s ease; }
        .nav-button.active { background-color: #8D7B68; color: white; }
        .nav-button:hover:not(.active) { background-color: #EFEBE4; }
        .sort-button { transition: all 0.2s ease-in-out; }
        .sort-button.active { 
            background-color: #A4907C; 
            color: white; 
            transform: translateY(-1px); 
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.08), 0 1px 2px -1px rgb(0 0 0 / 0.05);
        }
        .sort-button:hover:not(.active) { background-color: #f3f0ec; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-[#6F6051] mb-2">外食PFC・カロリーナビ</h1>
            <p class="text-md text-gray-600">主要外食チェーンのメニュー栄養情報をインタラクティブに探索・比較</p>
        </header>

        <main>
            <div id="info-sections">
                <section id="introduction" class="mb-12 bg-white/50 p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 text-[#8D7B68]">はじめに：データで選ぶ、次の一食</h2>
                    <p class="text-gray-700 leading-relaxed">
                        このアプリケーションは、日本の主要な外食チェーンのメニューに含まれる栄養情報（タンパク質、脂質、炭水化物、カロリー）を可視化し、比較検討を容易にすることを目的としています。下のフィルターや検索、並べ替え機能を活用して、あなたの健康目標や気分に合ったメニューを見つけてみましょう。データは各社の公式発表に基づいていますが、最新情報は公式サイトでご確認ください。
                    </p>
                </section>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg mb-12 border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-[#8D7B68]">絞り込み &amp; 並べ替え</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="font-semibold text-gray-700 block mb-2">チェーン店で絞り込む:</label>
                        <div id="chain-filters" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <label for="search-input" class="font-semibold text-gray-700 block mb-2">メニュー名で検索:</label>
                        <input type="text" id="search-input" placeholder="例: 牛丼, チーズ, ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A4907C] focus:border-transparent transition">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="font-semibold text-gray-700 block mb-2">並べ替え (最大2項目まで指定可能):</label>
                    <div id="sort-controls" class="flex flex-wrap gap-2"></div>
                </div>
                 <div id="ohsho-warning" class="mt-4 p-3 bg-amber-100 border-l-4 border-amber-500 text-amber-700 rounded-r-lg hidden">
                    <p><strong class="font-bold">お知らせ:</strong> 「餃子の王将」は、公式サイトでPFC（タンパク質・脂質・炭水化物）の詳細な一覧が提供されていないため、本ツールではカロリー以外のデータが表示されません。</p>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-12">
                <div class="xl:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold mb-4 text-[#8D7B68]">絞り込み結果の概要</h3>
                    <p class="text-sm text-gray-500 mb-4">現在の選択範囲での平均値です。</p>
                    <div id="summary-cards" class="space-y-4"></div>
                </div>
                <div class="xl:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4 text-[#8D7B68]">栄養バランス・ビジュアライゼーション</h3>
                     <p class="text-sm text-gray-500 mb-4">各メニューの栄養ポジションを視覚的に確認できます。点にカーソルを合わせると詳細が表示されます。</p>
                    <div class="chart-container">
                        <canvas id="pfc-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <section id="data-table-section" class="mb-12">
                <h2 class="text-2xl font-bold mb-4 text-[#8D7B68]">詳細データテーブル</h2>
                <div class="w-full overflow-x-auto bg-white rounded-2xl shadow-lg border border-gray-200 table-scrollbar">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 font-semibold">商品名</th>
                                <th class="p-4 font-semibold">チェーン店</th>
                                <th class="p-4 font-semibold text-right">タンパク質 (g)</th>
                                <th class="p-4 font-semibold text-right">脂質 (g)</th>
                                <th class="p-4 font-semibold text-right">炭水化物 (g)</th>
                                <th class="p-4 font-semibold text-right">カロリー (kcal)</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table-body">
                        </tbody>
                    </table>
                </div>
                <div id="no-results" class="text-center py-12 text-gray-500 hidden">
                    <p class="text-xl">該当するメニューが見つかりませんでした。</p>
                    <p>絞り込み条件を変更してお試しください。</p>
                </div>
            </section>
            
            <section id="disclaimer" class="mt-12 text-center text-sm text-gray-500 bg-gray-50 p-6 rounded-2xl border">
                 <h3 class="font-bold text-lg text-gray-700 mb-2">データの取り扱いに関するご注意</h3>
                 <p>本アプリケーションに表示される栄養成分データは、各飲食チェーンの公式サイトから取得したものです。メニューの改訂や情報の更新により、実際の数値と異なる場合があります。正確な情報が必要な場合や、アレルギー情報については、必ず各チェーンの公式サイトをご確認ください。データ取得日については各社PDFファイル名等をご参照ください。</p>
            </section>

        </main>
    </div>

    <script>
        const menuData = [
            // すき家 (sukiya20250527.pdf)
            { chain: 'すき家', name: '牛丼ミニ', protein: 15.7, fat: 17.2, carbs: 69.9, calories: 496 },
            { chain: 'すき家', name: '牛丼並盛', protein: 22.9, fat: 25.0, carbs: 104.1, calories: 732 },
            { chain: 'すき家', name: '牛丼中盛', protein: 28.4, fat: 35.8, carbs: 91.1, calories: 798 },
            { chain: 'すき家', name: '牛丼大盛', protein: 30.1, fat: 32.4, carbs: 138.6, calories: 967 },
            { chain: 'すき家', name: '牛丼特盛', protein: 40.4, fat: 48.9, carbs: 143.7, calories: 1176 },
            { chain: 'すき家', name: '牛丼メガ', protein: 54.3, fat: 71.0, carbs: 150.8, calories: 1458 },
            { chain: 'すき家', name: '鬼おろしポン酢牛丼並盛', protein: 24.0, fat: 25.1, carbs: 108.7, calories: 758 },
            { chain: 'すき家', name: 'ねぎ玉牛丼並盛', protein: 30.6, fat: 31.5, carbs: 109.1, calories: 839 },
            { chain: 'すき家', name: 'とろ〜り3種のチーズ牛丼並盛', protein: 33.2, fat: 37.2, carbs: 107.1, calories: 895 },
            { chain: 'すき家', name: 'わさび山かけ牛丼並盛', protein: 24.4, fat: 25.1, carbs: 115.4, calories: 785 },
            { chain: 'すき家', name: 'かつぶしオクラ牛丼並盛', protein: 24.7, fat: 25.1, carbs: 107.8, calories: 752 },
            { chain: 'すき家', name: '高菜明太マヨ牛丼並盛', protein: 24.5, fat: 32.9, carbs: 108.2, calories: 829 },
            { chain: 'すき家', name: 'キムチ牛丼並盛', protein: 24.5, fat: 25.4, carbs: 109.1, calories: 762 },
            { chain: 'すき家', name: '牛丼ライト並盛', protein: 24.3, fat: 28.5, carbs: 18.5, calories: 425 },
            { chain: 'すき家', name: 'カレー並盛', protein: 13.3, fat: 16.8, carbs: 118.8, calories: 680 },
            { chain: 'すき家', name: '牛カレー並盛', protein: 23.7, fat: 32.9, carbs: 124.5, calories: 889 },
            { chain: 'すき家', name: '旨だしとりそぼろ丼並盛', protein: 30.2, fat: 13.9, carbs: 108.5, calories: 683 },
            { chain: 'すき家', name: 'まぐろたたき丼並盛', protein: 29.2, fat: 10.1, carbs: 100.0, calories: 608 },
            { chain: 'すき家', name: '牛カルビ焼肉丼並盛', protein: 26.7, fat: 38.6, carbs: 112.2, calories: 902 },
            { chain: 'すき家', name: 'うな丼並盛', protein: 23.1, fat: 18.7, carbs: 104.1, calories: 679 },

            // 吉野家 (yoshinoya20250601.pdf)
            { chain: '吉野家', name: '牛丼小盛', protein: 15.4, fat: 19.6, carbs: 60.9, calories: 474 },
            { chain: '吉野家', name: '牛丼並盛', protein: 19.6, fat: 23.6, carbs: 88.2, calories: 633 },
            { chain: '吉野家', name: '牛丼アタマの大盛', protein: 23.0, fat: 28.8, carbs: 96.6, calories: 725 },
            { chain: '吉野家', name: '牛丼大盛', protein: 24.8, fat: 29.0, carbs: 119.5, calories: 823 },
            { chain: '吉野家', name: '牛丼特盛', protein: 33.5, fat: 44.2, carbs: 122.3, calories: 1006 },
            { chain: '吉野家', name: '豚丼並盛', protein: 14.4, fat: 18.6, carbs: 88.1, calories: 576 },
            { chain: '吉野家', name: 'ねぎ塩豚丼並盛', protein: 14.2, fat: 20.6, carbs: 90.0, calories: 599 },
            { chain: '吉野家', name: '牛カルビ丼(成型肉)並盛', protein: 24.0, fat: 30.3, carbs: 94.7, calories: 743 },
            { chain: '吉野家', name: '親子丼並盛', protein: 29.5, fat: 19.3, carbs: 101.7, calories: 695 },
            { chain: '吉野家', name: 'から揚げ丼並盛(から揚げ3個)', protein: 31.9, fat: 44.0, carbs: 104.5, calories: 943 }, 
            { chain: '吉野家', name: '黒カレー並盛', protein: 8.2, fat: 6.4, carbs: 100.5, calories: 480 },
            { chain: '吉野家', name: '牛黒カレー並盛', protein: 15.0, fat: 17.9, carbs: 103.3, calories: 622 },

            // 松屋 (matsuya20240213.pdf)
            { chain: '松屋', name: '牛めし小盛', protein: 13.5, fat: 22.8, carbs: 63.8, calories: 527 },
            { chain: '松屋', name: '牛めし並盛', protein: 17.7, fat: 29.0, carbs: 91.5, calories: 715 },
            { chain: '松屋', name: '牛めし大盛', protein: 22.8, fat: 36.0, carbs: 130.3, calories: 961 },
            { chain: '松屋', name: 'ネギたっぷり旨辛ネギたま牛めし並盛', protein: 20.5, fat: 29.0, carbs: 100.0, calories: 846 },
            { chain: '松屋', name: '鬼おろしポン酢牛めし並盛', protein: 18.9, fat: 29.1, carbs: 96.3, calories: 739 },
            { chain: '松屋', name: 'キムチ牛めし並盛', protein: 19.4, fat: 29.8, carbs: 100.5, calories: 764 },
            { chain: '松屋', name: 'チーズ牛めし並盛', protein: 31.6, fat: 46.1, carbs: 93.3, calories: 932 },
            { chain: '松屋', name: '松屋ビーフカレー並盛', protein: 17.0, fat: 27.8, carbs: 109.3, calories: 783 },
            { chain: '松屋', name: 'キムカル丼並盛', protein: 23.5, fat: 28.1, carbs: 104.3, calories: 781 },
            { chain: '松屋', name: '牛焼ビビン丼並盛', protein: 27.4, fat: 31.6, carbs: 99.8, calories: 811 },
            { chain: '松屋', name: '富士山豆腐の本格麻婆めし並盛', protein: 25.9, fat: 27.5, carbs: 103.8, calories: 793 },

            // やよい軒 (yayoiken20250318.pdf) 
            { chain: 'やよい軒', name: 'しょうが焼定食', protein: 26.2, fat: 37.1, carbs: 72.9, calories: 717 }, 
            { chain: 'やよい軒', name: '肉野菜炒め定食', protein: 26.4, fat: 18.6, carbs: 71.4, calories: 545 }, 
            { chain: 'やよい軒', name: 'チキン南蛮定食', protein: 29.5, fat: 57.0, carbs: 104.5, calories: 1038 }, 
            { chain: 'やよい軒', name: 'サバの塩焼定食', protein: 32.9, fat: 35.1, carbs: 61.9, calories: 686 }, 
            { chain: 'やよい軒', name: '地鶏親子丼～阿波尾鶏～ごはん普通盛', protein: 36.1, fat: 13.8, carbs: 107.1, calories: 683 },
            { chain: 'やよい軒', name: 'かつ丼ごはん普通盛', protein: 36.2, fat: 32.4, carbs: 128.2, calories: 935 },
            { chain: 'やよい軒', name: '鉄火丼ごはん普通盛', protein: 30.4, fat: 3.3, carbs: 94.5, calories: 520 },

            // マクドナルド (mcdonald20250602.pdf)
            { chain: 'マクドナルド', name: 'ハンバーガー', protein: 13.0, fat: 9.5, carbs: 30.3, calories: 259 },
            { chain: 'マクドナルド', name: 'チーズバーガー', protein: 15.9, fat: 13.5, carbs: 31.1, calories: 310 },
            { chain: 'マクドナルド', name: 'てりやきマックバーガー', protein: 14.5, fat: 30.2, carbs: 37.5, calories: 477 },
            { chain: 'マクドナルド', name: 'えびフィレオ', protein: 11.0, fat: 17.1, carbs: 50.9, calories: 399 },
            { chain: 'マクドナルド', name: 'ダブルチーズバーガー', protein: 26.4, fat: 25.1, carbs: 31.8, calories: 459 },
            { chain: 'マクドナルド', name: 'ビッグマック®', protein: 26.1, fat: 28.0, carbs: 42.0, calories: 525 },
            { chain: 'マクドナルド', name: 'フィレオフィッシュ®', protein: 15.0, fat: 14.2, carbs: 37.4, calories: 338 },
            { chain: 'マクドナルド', name: 'マックフライポテト® Mサイズ', protein: 5.3, fat: 21.0, carbs: 51.0, calories: 410 }, 
            
            // モスバーガー (mosburger20250521.pdf)
            { chain: 'モスバーガー', name: 'モスバーガー', protein: 15.2, fat: 17.0, carbs: 40.1, calories: 373 },
            { chain: 'モスバーガー', name: 'テリヤキバーガー', protein: 14.4, fat: 20.1, carbs: 40.6, calories: 384 },
            { chain: 'モスバーガー', name: 'モスチーズバーガー', protein: 18.2, fat: 21.4, carbs: 40.5, calories: 426 },
            { chain: 'モスバーガー', name: 'とびきりチーズ～北海道チーズ～', protein: 21.9, fat: 24.7, carbs: 42.2, calories: 479 },
            { chain: 'モスバーガー', name: 'ロースカツバーガー', protein: 16.6, fat: 16.4, carbs: 49.7, calories: 410 },
            { chain: 'モスバーガー', name: '海老カツバーガー', protein: 14.5, fat: 19.3, carbs: 42.2, calories: 397 },
            { chain: 'モスバーガー', name: 'モスライスバーガー海鮮かきあげ(塩だれ)', protein: 8.5, fat: 10.5, carbs: 61.3, calories: 372 },
            { chain: 'モスバーガー', name: 'フレンチフライポテトS', protein: 2.2, fat: 7.0, carbs: 24.8, calories: 170 },

            
              // なか卯（nakau20250421.pdf）完全版
              { chain: 'なか卯', name: '和風牛丼小盛', protein: 13.0, fat: 18.8, carbs: 62.6, calories: 485 },
              { chain: 'なか卯', name: '和風牛丼並盛', protein: 18.7, fat: 26.2, carbs: 95.2, calories: 713 },
              { chain: 'なか卯', name: '和風牛丼大盛', protein: 26.4, fat: 36.3, carbs: 124.1, calories: 955 },
              { chain: 'なか卯', name: '和風牛丼特盛', protein: 34.2, fat: 48.9, carbs: 143.7, calories: 1176 }, // ※PDFに特盛明記は少ないが、一部補完
              { chain: 'なか卯', name: '親子丼小盛', protein: 21.8, fat: 8.8, carbs: 62.0, calories: 425 },
              { chain: 'なか卯', name: '親子丼並盛', protein: 28.9, fat: 12.1, carbs: 94.9, calories: 620 },
              { chain: 'なか卯', name: '親子丼大盛', protein: 30.6, fat: 12.4, carbs: 120.9, calories: 738 },
              { chain: 'なか卯', name: '親子丼特盛', protein: 36.4, fat: 14.7, carbs: 121.2, calories: 783 },
              { chain: 'なか卯', name: 'カツ丼並盛', protein: 29.9, fat: 28.4, carbs: 107.8, calories: 820 },
              { chain: 'なか卯', name: 'カツ丼大盛', protein: 31.7, fat: 28.6, carbs: 133.7, calories: 938 },
              { chain: 'なか卯', name: '特製かき揚げ丼並盛', protein: 10.0, fat: 17.3, carbs: 102.8, calories: 623 },
              { chain: 'なか卯', name: '特製かき揚げ丼大盛', protein: 11.7, fat: 17.5, carbs: 128.7, calories: 741 },
              { chain: 'なか卯', name: 'チーズ親子丼並盛', protein: 37.0, fat: 21.7, carbs: 95.6, calories: 740 },
              { chain: 'なか卯', name: 'チーズ親子丼大盛', protein: 38.8, fat: 22.0, carbs: 121.6, calories: 857 },
              { chain: 'なか卯', name: 'チーズ牛丼並盛', protein: 33.6, fat: 37.1, carbs: 97.8, calories: 875 },
              { chain: 'なか卯', name: 'チーズ牛丼大盛', protein: 35.4, fat: 37.3, carbs: 123.8, calories: 992 },
              { chain: 'なか卯', name: '牛とじ丼並盛', protein: 38.9, fat: 29.2, carbs: 117.0, calories: 906 },
              { chain: 'なか卯', name: '牛とじ丼大盛', protein: 40.6, fat: 29.4, carbs: 143.0, calories: 1023 },
              { chain: 'なか卯', name: '親子カレー並盛', protein: 30.5, fat: 18.1, carbs: 99.2, calories: 696 },
              { chain: 'なか卯', name: '親子カレー大盛', protein: 32.2, fat: 18.3, carbs: 125.2, calories: 814 },
              { chain: 'なか卯', name: 'チキンカレー並盛', protein: 15.8, fat: 17.7, carbs: 107.5, calories: 673 },
              { chain: 'なか卯', name: 'チキンカレー大盛', protein: 17.5, fat: 17.9, carbs: 133.4, calories: 790 },
              { chain: 'なか卯', name: 'はいからうどん小', protein: 4.5, fat: 3.6, carbs: 28.7, calories: 166 },
              { chain: 'なか卯', name: 'はいからうどん並', protein: 8.1, fat: 7.2, carbs: 55.6, calories: 319 },
              { chain: 'なか卯', name: '牛肉うどん並', protein: 15.4, fat: 15.7, carbs: 60.9, calories: 453 },
              { chain: 'なか卯', name: '月見うどん並', protein: 16.1, fat: 14.0, carbs: 55.6, calories: 419 },
              { chain: 'なか卯', name: 'ざるうどん並', protein: 6.1, fat: 11.9, carbs: 11.7, calories: 178 },
              { chain: 'なか卯', name: 'ざるそば並', protein: 7.4, fat: 14.7, carbs: 6.1, calories: 190 },
              { chain: 'なか卯', name: '鶏天うどん並', protein: 14.6, fat: 15.7, carbs: 72.1, calories: 485 },
              { chain: 'なか卯', name: 'カレーうどん並', protein: 14.9, fat: 7.3, carbs: 77.8, calories: 437 },
              { chain: 'なか卯', name: '特製かき揚げうどん並', protein: 16.7, fat: 18.9, carbs: 74.3, calories: 534 },
              { chain: 'なか卯', name: '鶏天カレー並盛', protein: 22.5, fat: 6.6, carbs: 93.7, calories: 537 },
              { chain: 'なか卯', name: '唐揚げ（5個）', protein: 15.3, fat: 29.7, carbs: 29.3, calories: 445 },
              { chain: 'なか卯', name: '銀鮭', protein: 12.7, fat: 4.4, carbs: 0.1, calories: 91 },
              { chain: 'なか卯', name: '竜田あげ（2個）', protein: 6.1, fat: 11.9, carbs: 11.7, calories: 178 },
              { chain: 'なか卯', name: '竜田あげ（5個）', protein: 15.3, fat: 29.7, carbs: 29.3, calories: 445 },
              { chain: 'なか卯', name: '納豆', protein: 7.3, fat: 3.8, carbs: 4.9, calories: 83 },
              { chain: 'なか卯', name: '大根彩りサラダ', protein: 0.8, fat: 0.1, carbs: 2.6, calories: 12 },
              { chain: 'なか卯', name: 'ごはん小盛', protein: 3.8, fat: 0.5, carbs: 55.7, calories: 252 },
              { chain: 'なか卯', name: 'ごはん並盛', protein: 5.8, fat: 0.7, carbs: 85.3, calories: 387 },
              { chain: 'なか卯', name: 'ごはん大盛', protein: 7.5, fat: 0.9, carbs: 111.3, calories: 504 },
              { chain: 'なか卯', name: '缶ビール（350ml）', protein: 1.4, fat: 0.0, carbs: 9.5, calories: 140 },
              { chain: 'なか卯', name: '黒烏龍茶', protein: 0.0, fat: 0.0, carbs: 0.1, calories: 1 },
              { chain: 'なか卯', name: 'アイスコーヒー', protein: 0.2, fat: 0.0, carbs: 0.1, calories: 1 },
              { chain: 'なか卯', name: 'ホットコーヒー', protein: 0.2, fat: 0.0, carbs: 0.1, calories: 1 },
              { chain: 'なか卯', name: 'お子様きつねうどん', protein: 3.0, fat: 1.5, carbs: 7.7, calories: 55 },
              { chain: 'なか卯', name: 'お子様カレー丼ぶり', protein: 7.9, fat: 6.8, carbs: 0.3, calories: 100 },

            // 餃子の王将 (既存データ、PDF提供なし)
            { chain: '餃子の王将', name: '餃子 (1人前6ヶ)', protein: null, fat: null, carbs: null, calories: 312 },
            { chain: '餃子の王将', name: '炒飯', protein: null, fat: null, carbs: null, calories: 746 },
            { chain: '餃子の王将', name: '天津飯', protein: null, fat: null, carbs: null, calories: 780 },
        ];

        const chainColors = {
            'すき家': { bg: 'bg-red-50', border: 'border-red-200', point: 'rgba(239, 68, 68, 0.7)', pointBorder: 'rgb(239, 68, 68)' },
            '吉野家': { bg: 'bg-orange-50', border: 'border-orange-200', point: 'rgba(249, 115, 22, 0.7)', pointBorder: 'rgb(249, 115, 22)' },
            '松屋': { bg: 'bg-yellow-50', border: 'border-yellow-200', point: 'rgba(234, 179, 8, 0.7)', pointBorder: 'rgb(234, 179, 8)' },
            'やよい軒': { bg: 'bg-purple-50', border: 'border-purple-200', point: 'rgba(168, 85, 247, 0.7)', pointBorder: 'rgb(168, 85, 247)' },
            'マクドナルド': { bg: 'bg-red-500/10', border: 'border-red-300', point: 'rgba(220, 38, 38, 0.7)', pointBorder: 'rgb(220, 38, 38)' },
            'モスバーガー': { bg: 'bg-green-50', border: 'border-green-200', point: 'rgba(34, 197, 94, 0.7)', pointBorder: 'rgb(34, 197, 94)' },
            'なか卯': { bg: 'bg-blue-50', border: 'border-blue-200', point: 'rgba(59, 130, 246, 0.7)', pointBorder: 'rgb(59, 130, 246)' },
            '餃子の王将': { bg: 'bg-gray-100', border: 'border-gray-300', point: 'rgba(156, 163, 175, 0.7)', pointBorder: 'rgb(156, 163, 175)' },
        };

        let activeChains = Object.keys(chainColors);
        let searchTerm = '';
        let sortConfigs = [{ key: 'calories', direction: 'desc' }]; // 初期ソート: カロリー降順

        const chainFiltersContainer = document.getElementById('chain-filters');
        const searchInput = document.getElementById('search-input');
        const tableBody = document.getElementById('menu-table-body');
        const chartElement = document.getElementById('pfc-chart');
        const sortControlsContainer = document.getElementById('sort-controls');
        const summaryCardsContainer = document.getElementById('summary-cards');
        const noResultsDiv = document.getElementById('no-results');
        const ohshoWarningDiv = document.getElementById('ohsho-warning');

        let pfcChart;

        function initializeApp() {
            setupChainFilters();
            setupSortControls();
            setupEventListeners();
            updateApp();
        }

        function setupChainFilters() {
            Object.keys(chainColors).forEach(chain => {
                const button = document.createElement('button');
                button.textContent = chain;
                button.dataset.chain = chain;
                button.className = `px-3 py-1.5 border rounded-full text-sm font-medium nav-button ${chainColors[chain].border} ${activeChains.includes(chain) ? 'active' : ''}`;
                button.onclick = () => toggleChainFilter(chain);
                chainFiltersContainer.appendChild(button);
            });
        }

        function setupSortControls() {
            const keys = [
                { key: 'protein', label: 'タンパク質' },
                { key: 'fat', label: '脂質' },
                { key: 'carbs', label: '炭水化物' },
                { key: 'calories', label: 'カロリー' }
            ];
            keys.forEach(({ key, label }) => {
                const button = document.createElement('button');
                button.textContent = label; // 初期表示はラベル名のみ
                button.dataset.key = key;
                button.dataset.label = label; // 元のラベルを保持
                button.className = 'sort-button px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 transition';
                button.onclick = () => setSortConfig(key);
                sortControlsContainer.appendChild(button);
            });
        }

        function setupEventListeners() {
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                updateApp();
            });
        }

        function toggleChainFilter(chain) {
            const index = activeChains.indexOf(chain);
            if (index > -1) {
                activeChains.splice(index, 1);
            } else {
                activeChains.push(chain);
            }
            updateApp();
        }

        function setSortConfig(clickedKey) {
            const existingConfigIndex = sortConfigs.findIndex(sc => sc.key === clickedKey);

            if (existingConfigIndex !== -1) {
                // キーが既に存在する場合、方向を反転し、先頭に移動
                const existingConfig = sortConfigs.splice(existingConfigIndex, 1)[0];
                existingConfig.direction = existingConfig.direction === 'asc' ? 'desc' : 'asc';
                sortConfigs.unshift(existingConfig);
            } else {
                // 新しいキーの場合、降順で先頭に追加
                sortConfigs.unshift({ key: clickedKey, direction: 'desc' });
            }

            // ソートキーが2つを超えたら、古いもの（末尾）を削除
            if (sortConfigs.length > 2) {
                sortConfigs.pop();
            }
            updateApp();
        }

        function updateApp() {
            const filteredData = getFilteredAndSortedData();
            renderTable(filteredData);
            renderChart(filteredData);
            updateFilterButtons();
            updateSortButtons();
            renderSummary(filteredData);
            checkOhshoWarning();
        }

        function getFilteredAndSortedData() {
            let data = menuData.filter(item => 
                activeChains.includes(item.chain) &&
                item.name.toLowerCase().includes(searchTerm)
            );

            data.sort((a, b) => {
                for (let i = 0; i < sortConfigs.length; i++) {
                    const config = sortConfigs[i];
                    const valA = a[config.key];
                    const valB = b[config.key];

                    // null 値の処理: null を常に最後に持っていく (昇順・降順共通)
                    if (valA === null && valB === null) continue; // 両方nullなら次のキーへ
                    if (valA === null) return 1;  // aがnullならbを前に
                    if (valB === null) return -1; // bがnullならaを前に
                    
                    let comparison = 0;
                    if (valA < valB) {
                        comparison = -1;
                    } else if (valA > valB) {
                        comparison = 1;
                    }

                    if (comparison !== 0) {
                        return config.direction === 'asc' ? comparison : -comparison;
                    }
                }
                return 0; // 全てのキーで等しい場合
            });
            return data;
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                noResultsDiv.classList.remove('hidden');
                return;
            }
            noResultsDiv.classList.add('hidden');
            
            data.forEach(item => {
                const row = document.createElement('tr');
                const color = chainColors[item.chain];
                row.className = `${color.bg} border-b ${color.border} hover:bg-opacity-50`;
                
                row.innerHTML = `
                    <td class="p-4 font-medium">${item.name}</td>
                    <td class="p-4">${item.chain}</td>
                    <td class="p-4 text-right">${item.protein !== null ? item.protein.toFixed(1) : 'N/A'}</td>
                    <td class="p-4 text-right">${item.fat !== null ? item.fat.toFixed(1) : 'N/A'}</td>
                    <td class="p-4 text-right">${item.carbs !== null ? item.carbs.toFixed(1) : 'N/A'}</td>
                    <td class="p-4 text-right font-bold">${item.calories !== null ? Math.round(item.calories) : 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function renderSummary(data) {
            summaryCardsContainer.innerHTML = '';
            
            if (data.length === 0) {
                summaryCardsContainer.innerHTML = `<p class="text-gray-500">データがありません。</p>`;
                return;
            }

            const metrics = ['protein', 'fat', 'carbs', 'calories'];
            const labels = {
                protein: 'タンパク質',
                fat: '脂質',
                carbs: '炭水化物',
                calories: 'カロリー'
            };
             const units = {
                protein: 'g',
                fat: 'g',
                carbs: 'g',
                calories: 'kcal'
            };

            const averages = metrics.reduce((acc, key) => {
                const validData = data.filter(d => d[key] !== null && typeof d[key] === 'number');
                if (validData.length === 0) {
                    acc[key] = null;
                    return acc;
                }
                const sum = validData.reduce((total, item) => total + item[key], 0);
                acc[key] = sum / validData.length;
                return acc;
            }, {});

            Object.keys(averages).forEach(key => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                const value = averages[key];
                card.innerHTML = `
                    <p class="text-sm text-gray-500">平均${labels[key]}</p>
                    <p class="text-2xl font-bold text-[#8D7B68]">${value !== null ? value.toFixed(1) : 'N/A'} <span class="text-base font-normal">${units[key]}</span></p>
                `;
                summaryCardsContainer.appendChild(card);
            });
        }

        function renderChart(data) {
            const chartData = {
                datasets: data
                    .filter(item => item.calories !== null && item.protein !== null && typeof item.calories === 'number' && typeof item.protein === 'number')
                    .map(item => ({
                        label: `${item.chain} - ${item.name}`,
                        data: [{
                            x: item.calories,
                            y: item.protein,
                            r: (item.fat !== null && typeof item.fat ==='number') ? Math.max(item.fat / 2, 5) : 5,
                        }],
                        backgroundColor: chainColors[item.chain].point,
                        borderColor: chainColors[item.chain].pointBorder,
                        borderWidth: 1,
                    }))
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'カロリー (kcal)', font: { size: 14 } },
                        beginAtZero: true
                    },
                    y: {
                        title: { display: true, text: 'タンパク質 (g)', font: { size: 14 } },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const originalItemArray = menuData.filter(d => 
                                    d.name === context.dataset.label.split(' - ')[1] &&
                                    d.chain === context.dataset.label.split(' - ')[0]
                                );
                                if (!originalItemArray || originalItemArray.length === 0) return '';
                                const originalItem = originalItemArray[0]; 
                                let label = originalItem.name;
                                let lines = [
                                    `${originalItem.chain} - ${label}`,
                                    `カロリー: ${originalItem.calories !== null ? originalItem.calories.toFixed(0) : 'N/A'} kcal`,
                                    `タンパク質: ${originalItem.protein !== null ? originalItem.protein.toFixed(1) : 'N/A'} g`,
                                    `脂質: ${originalItem.fat !== null ? originalItem.fat.toFixed(1) : 'N/A'} g`,
                                    `炭水化物: ${originalItem.carbs !== null ? originalItem.carbs.toFixed(1) : 'N/A'} g`,
                                ];
                                return lines;
                            }
                        },
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 4,
                        displayColors: false,
                    }
                }
            };

            if (pfcChart) {
                pfcChart.data = chartData;
                pfcChart.update();
            } else {
                pfcChart = new Chart(chartElement, {
                    type: 'bubble',
                    data: chartData,
                    options: chartOptions
                });
            }
        }
        
        function updateFilterButtons() {
            document.querySelectorAll('#chain-filters button').forEach(button => {
                if (activeChains.includes(button.dataset.chain)) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function updateSortButtons() {
            document.querySelectorAll('#sort-controls button').forEach(button => {
                const key = button.dataset.key;
                const originalLabel = button.dataset.label;
                const sortSettingIndex = sortConfigs.findIndex(sc => sc.key === key);

                if (sortSettingIndex !== -1) {
                    button.classList.add('active');
                    const sortSetting = sortConfigs[sortSettingIndex];
                    const directionArrow = sortSetting.direction === 'asc' ? '↑' : '↓';
                    button.textContent = `${sortSettingIndex + 1}: ${directionArrow} ${originalLabel}`;
                } else {
                    button.classList.remove('active');
                    button.textContent = originalLabel;
                }
            });
        }

        function checkOhshoWarning() {
            if (activeChains.includes('餃子の王将')) {
                ohshoWarningDiv.classList.remove('hidden');
            } else {
                ohshoWarningDiv.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
